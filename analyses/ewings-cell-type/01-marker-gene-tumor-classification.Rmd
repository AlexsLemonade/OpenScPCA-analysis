---
title: "Manual classification of tumor cells"
author: Ally Hawkins
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
params:
  sample_id: SCPCS000490
  library_id: SCPCL000822
---


## Introduction

This notebook looks at expression of marker genes for tumor cells in a Ewing sarcoma sample, `r {params$sample_id}`. 
We then see if we can use expression of marker genes to manually classify tumor and normal cells.
The main goal of this notebook is only to identify tumor cells, identification and labelling of the other cells is a separate question that we do not answer here. 

- First we look at expression of each of the marker genes across all cells. 
- Then we use a z-transform prior to summing expression of all marker genes. 
Cells with a z-score for any marker gene > 0 are classified as tumor cells. 
- We look at marker genes for these tumor cells using `scran::findMarkers()` and compare to the tumor markers.
- Marker gene expression is examined across clusters and tumor and normal cells are classified using clusters rather than individual cells. 
- Finally, we compare the cells classified as tumor/normal manually to assignments from `SingleR` and `CellAssign`. 

## Setup

```{r packages}
suppressMessages(
  # load required packages
  library(SingleCellExperiment),
  library(ggplot2)
)
```


```{r base paths}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
repository_base <- rprojroot::find_root(rprojroot::is_git_root)

# The current data directory, found within the repository base directory
data_dir <- file.path(repository_base, "data", "current")
sample_dir <- file.path(data_dir, "SCPCP000015", params$sample_id)

# The path to this module
module_base <- file.path(repository_base, "analyses", "ewings-cell-type")

# source in helper functions
jaccard_functions <- file.path(module_base, "scripts", "utils", "jaccard-functions.R")
source(jaccard_functions)
```


```{r paths}
# Input files
sce_filename <- glue::glue("{params$library_id}_processed_annotated.rds")
sce_file <- file.path(sample_dir, sce_filename)

marker_genes <- file.path(module_base, "references", "tumor-marker-genes.tsv")
```

```{r}
# read in processed sce
sce <- readr::read_rds(sce_file)

# read in marker genes table 
marker_genes_df <- readr::read_tsv(marker_genes) |> 
  # account for genes being from multiple sources
  dplyr::select(cell_type, ensembl_gene_id, gene_symbol) |> 
  dplyr::distinct()

marker_genes <- marker_genes_df |> 
  dplyr::filter(cell_type == "tumor") |> 
  dplyr::pull(ensembl_gene_id)
```


## Analysis content

### Explore marker gene expression 

The first thing we do here is just create a faceted UMAP showing the expression of each marker gene for tumor cells. 

```{r}
# get the gene expression counts for all marker genes
marker_gene_exp <- logcounts(sce[marker_genes, ]) |>
  as.matrix() |>
  t() |>
  as.data.frame() |>
  tibble::rownames_to_column("barcodes")

# pull out the UMAP coordinates and make a data frame to use for plotting
umap_df <- sce |> 
  scuttle::makePerCellDF(use.dimred = "UMAP") |> 
  # replace UMAP.1 with UMAP1
  dplyr::rename_with(
        \(x) stringr::str_replace(x, "^UMAP\\.", "UMAP"),
        starts_with("UMAP")
      ) |> 
  # add in marker gene expression to dataframe 
  dplyr::left_join(marker_gene_exp, by = "barcodes") |> 
  # combine all genes into a single column for easy faceting
  tidyr::pivot_longer(
    cols = starts_with("ENSG"),
    names_to = "ensembl_gene_id",
    values_to = "gene_expression"
  ) |> 
  # join with marker gene df to get gene symbols for plotting 
  dplyr::left_join(marker_genes_df, by = c("ensembl_gene_id")) |>
  dplyr::select(barcodes, UMAP1, UMAP2, gene_symbol, ensembl_gene_id, gene_expression, cluster)
```


```{r}
# faceted umap showing a umap panel for each marker gene 
ggplot(umap_df, aes(x = UMAP1, y = UMAP2, color = gene_expression)) +
    geom_point(alpha = 0.1, size = 0.2) +
    facet_wrap(vars(gene_symbol)) +
    scale_color_viridis_c() +
    labs(
      color = "Log-normalized gene expression"
    ) +
    # remove axis numbers and background grid
    scale_x_continuous(labels = NULL, breaks = NULL) +
    scale_y_continuous(labels = NULL, breaks = NULL) +
    theme(
      aspect.ratio = 1,
      legend.position = "bottom",
      axis.title = element_text(size = 9, color = "black"),
      strip.text = element_text(size = 8),
      legend.title = element_text(size = 9),
      legend.text = element_text(size = 8)
    ) +
    guides(colour = guide_colorbar(title.position = "bottom", title.hjust = 0.5)) +
  theme_bw()
```

Looking at this plot, there is definitely some variation in the expression of marker genes. 
It looks like the highest gene expression is seen in the larger group of cells on the bottom right of the UMAP. 

```{r}
ggplot(umap_df, aes(x = gene_expression, fill = gene_symbol)) +
  geom_density() +
  theme_bw() +
  facet_wrap(vars(gene_symbol))
```

Now we will transform each of the gene expression vectors by generating z-scores. 
Then we might be able to find a cut off we can use across samples for if marker genes are present in a cell or not. 

```{r}
# get the z-scores for all genes, transforming across each column that contains expression for a given gene 
transformed_exp_df <- umap_df |> 
  dplyr::select(barcodes, gene_symbol, gene_expression) |> 
  tidyr::pivot_wider(
    names_from = "gene_symbol",
    values_from = "gene_expression") |> 
  dplyr::mutate(across(!barcodes, ~ scale(.x))) |> 
  tidyr::pivot_longer(
    cols = - barcodes,
    names_to = "gene_symbol",
    values_to = "transformed_gene_expression"
  )

# add the transformed gene expression back to the main df used for plotting
umap_df <- umap_df |> 
  dplyr::left_join(transformed_exp_df, by = c("barcodes", "gene_symbol"))
```

Now we can create the same density plot but looking at z-scores. 

```{r}
ggplot(umap_df, aes(x = transformed_gene_expression, fill = gene_symbol)) +
  geom_density() +
  theme_bw() +
  facet_wrap(vars(gene_symbol))
```

It looks like some marker genes have distinct groups of cells with z-score > 0, while other marker genes may not be as informative. 
Keep in mind this could vary somewhat across patients, so I'm wary to remove marker genes without looking across multiple references. 

### Classify tumor cells using marker genes only

Let's try and use the marker gene expression to classify tumor cells. 
It looks like we could use a cutoff of z-score > 0 to count that cell as a tumor cell. 

We could either count any cell that expresses at least one marker gene > 0 as a tumor cell, or look at the combined expression. 
Let's start with classifying tumor cells as tumor if any marker gene is present (z-score > 0). 
This also means the sum of all z-scores > 0. 

Below, we can get the sum of the transformed gene expression of all marker genes and plot in a single UMAP. 

```{r}
# calculate sum gene expression across all marker genes in list 
marker_sum_exp <- umap_df |> 
  dplyr::group_by(barcodes) |> 
  dplyr::mutate(sum_exp = sum(transformed_gene_expression)) |> 
  dplyr::select(barcodes, UMAP1, UMAP2, sum_exp, cluster) |> 
  dplyr::distinct()

# plot mean gene expression 
ggplot(marker_sum_exp, aes(x = UMAP1, y = UMAP2, color = sum_exp)) +
  geom_point(size = 0.5, alpha = 0.5) +
  scale_color_viridis_c() +
  theme_bw()
```
Similar to the individual plots, it looks like there is one group of cells on the bottom right that has the highest marker gene expression. 
We would anticipate that these are most likely to be the tumor cells. 

Now let's classify any cell that has a sum of marker genes > 0 (after z-transformation) as tumor cells. 

```{r}
# classify tumor cells based on presence of any marker genes 
marker_sum_exp <- marker_sum_exp |> 
  dplyr::mutate(sum_classification = dplyr::if_else(sum_exp > 0, "Tumor", "Normal"))

ggplot(marker_sum_exp, aes(x = UMAP1, y = UMAP2, color = sum_classification)) +
  geom_point(size = 0.5, alpha = 0.5) +
  theme_bw()
```

This gives us a rough idea of cells that may be classified as tumor cells. 
Let's look at the expression of each marker gene in tumor vs. normal cells and see if we see distinct separation between all of them or only a subset. 

```{r}
# add cell types from sum classification to plotting df 
celltype_df <- umap_df |> 
  dplyr::left_join(marker_sum_exp)

# make plot with gene on y-axis, expression on x-axis and then color density by tumor/normal 
# do all marker genes so differences between tumor/normal or only a subset? 
ggplot(celltype_df, aes(x=transformed_gene_expression, color = sum_classification)) +
  geom_density() +
  facet_wrap(vars(gene_symbol)) +
  theme_bw()
```

It looks like ADGRG2, HES1, NROB1, and STEAP1 don't show a lot of difference between cells that might be tumor vs. normal cells and are generally lowly expressed.
CD99 appears to be expressed in both normal and tumor at similar levels. 
All other genes show differences between the two, although at varying degrees. 
Again, we should make sure this is consistent across multiple patients before removing these genes as marker genes. 

### Marker genes using `findMarkers`

Below, we will use `scran::findMarkers()` to find any markers between tumor and normal cells. 
Since we used marker genes to classify tumor cells, I would expect that at least some of the top markers would be from our list of tumor markers. 

```{r}
# add in tumor/normal classification to colData of SCE 
celltypes_only_df <- marker_sum_exp |> 
  dplyr::select(barcodes, sum_classification)

coldata_df <- as.data.frame(colData(sce)) |> 
  dplyr::left_join(celltypes_only_df)

colData(sce) <- DataFrame(coldata_df, row.names = rownames(coldata_df))

# find markers between tumor and normal 
markers <- scran::findMarkers(sce,
                              groups = sce$sum_classification,
                              pval.type = "all") 
```

```{r}
# pull out top markers for tumor cells 
tumor_markers <- markers$Tumor |> 
  as.data.frame() |> 
  tibble::rownames_to_column("ensembl_gene_id") |> 
  dplyr::left_join(marker_genes_df) |>
  # just take those with FDR < 0.05 and logFC > 1.5
  dplyr::filter(FDR < 0.05, summary.logFC > 1.5) |> 
  dplyr::arrange(FDR) 

# get any marker genes that are in both findMarkers and our curated list
marker_gene_intersect <- tumor_markers |> 
  dplyr::filter(cell_type == "tumor")

# print out genes that are marker genes for both 
marker_gene_intersect
```

### Using clusters and marker gene expression to annotate tumor cells

We anticipate that the tumor cells and normal cells would cluster separately. 
First, let's just plot the cluster assignments alone.  

These are clusters calculated in `scpca-nf` and its probable that these aren't the best clusters to use. 
Separately, we will evaluate clustering for these samples, but for now we will look at the clusters we have. 

```{r}
# plot clusters on UMAP
ggplot(marker_sum_exp, aes(x = UMAP1, y = UMAP2, color = cluster)) +
  geom_point(size = 0.5, alpha = 0.5) +
  theme_bw()
```

It looks like our large group of cells on the bottom right is comprised of a few clusters while most other groups of cells are a single cluster. 

We can then look at marker gene expression across clusters.
Below we visualize the total number of cells in each cluster that are classified as tumor or normal using the sum of marker gene expression. 
Then for each set of cells, how many of those actually express each marker gene. 

We expect to see two things: 

- Tumor cells and normal cells tend to separate by cluster. 
- Good marker genes will be expressed in tumor cells but not normal cells. 

```{r, fig.height=10, fig.width=10}
cluster_plot_df <- celltype_df |> 
  dplyr::mutate(gene_expresed = dplyr::if_else(transformed_gene_expression > 0, TRUE, FALSE)) |> 
  dplyr::select(gene_symbol, gene_expresed, sum_classification, cluster)

ggplot(cluster_plot_df, aes(x = sum_classification, fill = gene_expresed)) +
  geom_bar(stat = "count") +
  facet_grid(rows = vars(gene_symbol),
             cols = vars(cluster)) +
  scale_fill_manual(values = c("grey", "blue")) +
  theme_classic()
  
```

Looking at this, most clusters are made up mostly of either normal or tumor. 
Also, genes like ADGRG2 and HES1 do not seem specific to tumor cells. There are normal and tumor cells that express the gene and not very many tumor cells actually have expression of ADGRG2. 
STEAP1 and NROB1 although not expressed in very many tumor cells, look to be specific to tumor cells which is promising. 

CD99 and CCND1 are expressed in a high proportion of tumor cells but are also expressed in quite a few groups of normal cells. 
This is consistent with the literature for CD99 that it is expressed in normal cells, just at a lower level than in Ewing's cells. 

Almost all genes have at least some expression in normal cells. 
Perhaps those cells should also be categorized as tumor cells, or they do have some baseline expression in normal cells which is possible. 

Now we can classify the cells based on clustering and marker gene expression. 

```{r}
# plot marker gene expression across all clusters 
ggplot(marker_sum_exp, aes(x = sum_exp, fill = cluster)) +
  geom_density() +
  facet_grid(rows = vars(cluster)) +
  theme_bw()
```

Looking at this there are definitely clusters with higher sum expression of the marker genes than other cells. 
If the cluster has a median expression > 0 then all cells in that cluster will get assigned as tumor cells. 

```{r}
# classify clusters as tumor/normal 
cluster_classification_df <- marker_sum_exp |> 
  dplyr::group_by(cluster) |> 
  # calculate the median mean gene expression across all cells in a cluster
  dplyr::summarise(median_cluster_exp = median(sum_exp)) |> 
  # use 0.75 as the cutoff for tumor/normal 
  dplyr::mutate(cluster_classification = dplyr::if_else(median_cluster_exp > 0, "Tumor", "Normal"))

# get individual cell classifications
celltype_classification_df <- marker_sum_exp |> 
  dplyr::left_join(cluster_classification_df)

# umap showing tumor and normal cells 
ggplot(celltype_classification_df, aes(x = UMAP1, y = UMAP2, color = cluster_classification)) +
  geom_point(size = 0.5, alpha = 0.5) +
  theme_bw()
```

### Compare with SingleR and CellAssign classifictions 

The last thing we will do here is compare our manual annotations with the annotations using `SingleR` and `CellAssign`. 
Looking at the annotations and UMAPs in the supplemental report, it looks like our group of "Tumor" cells are classified mostly as "Muscle cells" by both SingleR and CellAssign. 
This makes sense since Ewing's sarcoma cells tend to resemble muscle cells. 

I would expect the Endothelial cells, Fibroblasts, and Macrophages assigned by `CellAssign` and `SingleR` to line up with the normal cells in this sample. 

Let's create a heatmap looking at the Jaccard similarity index between each of the assigned cell types and the tumor/normal classification.  

```{r}
# get all assigned cell types in one dataframe 
celltypes_df <- as.data.frame(colData(sce)) |> 
  dplyr::select(barcodes, singler_celltype_annotation, cellassign_celltype_annotation) |> 
  dplyr::left_join(marker_sum_exp)

celltype_columns <- c(
  "singler_celltype_annotation",
  "cellassign_celltype_annotation"
)

# create jaccard matrices for SingleR and CellAssign compared to tumor/normal 
jaccard_matrices <- celltype_columns |>
  purrr::map(\(name) {
    make_jaccard_matrix(
      celltypes_df,
      "sum_classification",
      name
    )
  }) |> 
  purrr::set_names("SingleR", "CellAssign")
```


```{r, fig.height=10, fig.width=7}
# Set heatmap padding option
heatmap_padding <- 0.2
ComplexHeatmap::ht_opt(TITLE_PADDING = grid::unit(heatmap_padding, "in"))

# list of heatmaps looking at SingleR/ CellAssign vs tumor/normal 
heatmap <- jaccard_matrices |>
  purrr::imap(
    \(celltype_mat, celltype_method) {
      ComplexHeatmap::Heatmap(
        t(celltype_mat), # transpose because matrix rows are in common & we want a vertical arrangement
        col = circlize::colorRamp2(c(0, 1), colors = c("white", "darkslateblue")),
        border = TRUE,
        ## Row parameters
        cluster_rows = TRUE,
        row_title = celltype_method,
        row_title_gp = grid::gpar(fontsize = 12),
        row_title_side = "left",
        row_names_side = "left",
        row_dend_side = "right",
        row_names_gp = grid::gpar(fontsize = 10),
        ## Column parameters
        cluster_columns = FALSE,
        column_title = "",
        column_title_gp = grid::gpar(fontsize = 12),
        column_names_side = "bottom",
        column_names_gp = grid::gpar(fontsize = 10),
        column_names_rot = 90,
        ## Legend parameters
        heatmap_legend_param = list(
          title = "Jaccard index",
          direction = "vertical",
          legend_width = unit(1.5, "in")
        ),
        show_heatmap_legend = celltype_method == "SingleR",
      )
    }) |>
  # concatenate vertically into HeatmapList object
  purrr::reduce(ComplexHeatmap::`%v%`) |>
  ComplexHeatmap::draw(
    heatmap_legend_side = "right",
    # add a margin to the heatmap so labels don't get cut off
    padding = unit(c(2, 20, 2, 2), "mm")
  )
```

When looking at `SingleR`, we see that the tumor cells line up with smooth muscle cells, chondrocytes, neurons, and fibroblasts. 
Ewing's cells have a neuronal like phenotype and express high levels of ECM genes, which may explain the overlap with chondrocytes and fibroblasts. 
We do see that macrophages and endothelial cells tend to line up with the normal cells, which is expected. 

For CellAssign, all tumor cells are pulmonary vascular smooth muscle cells. 
We also see tha normal cells contain some smooth muscle cells, but mostly are fibroblasts and endothelial cells. 

Looking at the heatmap in the supplemental report, the endothelial cells called by SingleR and CellAssign have a lot of overlap. 
Let's look at expression of marker genes in these endothlial cells compared to cells that are categorized as smooth muscle cells. 

```{r}
select_celltype_df <- celltypes_df |> 
  dplyr::mutate(
    automated_annotation = dplyr::case_when(
      singler_celltype_annotation == "smooth muscle cell" & cellassign_celltype_annotation == "Pulmonary vascular smooth muscle cells" ~ "Muscle cell",
      singler_celltype_annotation == "endothelial cell" & cellassign_celltype_annotation == "Endothelial cells" ~ "Endothelial cell"
    )
  ) |> 
  dplyr::select(barcodes, automated_annotation)

annotation_plot_df <- umap_df |> 
  dplyr::left_join(select_celltype_df) |>
  dplyr::filter(!is.na(automated_annotation))

ggplot(annotation_plot_df, aes(x = transformed_gene_expression, color = automated_annotation)) +
  geom_density() +
  facet_wrap(vars(gene_symbol)) +
  theme_bw()
```

Consistent with previous findings, ADGRG2, HES1, NROB1, and STEAP1 don't seem to show any expression in either groups of cells. 
CCND1 and CD99 appear to have similar expression across both groups of cells, while MAPT and PRKCB seem to have the most distinct expression profiles between muscle and endothelial cells. 

## Conclusions 

- We do see variation in marker gene expression across cells, suggesting that there are both tumor and normal cells here. - Using a z-score cut-off identifies a group of cells that appear to be tumor. 
- This mostly lines up with the default clustering that has been performed, where tumor and normal cells have been separated.
- The top marker genes for the "tumor" cells contain PRKCB and MAPT, two of the marker genes in our gene list. 
- It's likely that ADGRG2, HES1, NROB1, and STEAP1 will not be informative in assigning tumor cells. 
- We may be weary of genes like CD99 too as expression is more consistent across cells rather than specific to a group of cells. 
- Endothelial cells as identified by SingleR and CellAssign generally have low expression of these marker genes and muscle cells have higher expression of marker genes. 

## Session Info

```{r session info}
# record the versions of the packages used in this analysis and other environment information
sessionInfo()
```
