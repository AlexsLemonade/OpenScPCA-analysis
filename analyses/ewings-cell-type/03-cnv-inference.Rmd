---
title: "Copy number inference with Ewing sarcoma samples"
author: Ally Hawkins
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
params:
  sample_id: SCPCS000490
  library_id: SCPCL000822
---


## Introduction

## Setup

```{r packages}
suppressPackageStartupMessages({
  # load required packages
  library(SingleCellExperiment)
  library(ggplot2)
  library(copykat)
})
```


```{r base paths}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
repository_base <- rprojroot::find_root(rprojroot::is_git_root)

# The current data directory, found within the repository base directory
data_dir <- file.path(repository_base, "data", "current")
sample_dir <- file.path(data_dir, "SCPCP000015", params$sample_id)

# The path to this module
module_base <- file.path(repository_base, "analyses", "ewings-cell-type")

# source in helper functions
jaccard_functions <- file.path(module_base, "scripts", "utils", "jaccard-functions.R")
source(jaccard_functions)
```


```{r paths}
# Input files
sce_filename <- glue::glue("{params$library_id}_processed.rds")
sce_file <- file.path(sample_dir, sce_filename)

# tumor/normal classifications 
classifications_filename <- glue::glue("{params$library_id}_tumor_normal_classifications.tsv")
classifications_file <- file.path(module_base, "results", "marker_gene_analysis", classifications_filename)

# output files 
```


```{r}
# read in processed sce
sce <- readr::read_rds(sce_file)
```


## Analysis content

### CopyKAT

```{r}
ck_results <- copykat::copykat(rawmat = as.matrix(counts(sce)),
                               id.type = "E", 
                               n.cores = 4)
```

Save these results so we don't need to re-run! 
```{r}
table(ck_results$prediction$copykat.pred)
# temp save ck_results 
readr::write_rds(ck_results, "results/SCPCL000490_copykat_results.rds")
```

```{r}
umap_df <- sce |> 
  scuttle::makePerCellDF(use.dimred = "UMAP") |> 
  # replace UMAP.1 with UMAP1
  dplyr::rename_with(
        \(x) stringr::str_replace(x, "^UMAP\\.", "UMAP"),
        starts_with("UMAP")
      )

ck_preds <- ck_results$prediction |> 
  dplyr::rename(
    barcodes = cell.names
  )

cnv_df <- umap_df |> 
  dplyr::left_join(ck_preds)
```

```{r}
ggplot(cnv_df, aes(x = UMAP1, y = UMAP2, color = copykat.pred)) +
  geom_point(alpha = 0.5, size = 0.5) +
  theme_bw()
```

```{r}
# read in tumor normal classifications 
manual_classifications_df <- readr::read_tsv(classifications_file)

cnv_df <- cnv_df |> 
  dplyr::left_join(manual_classifications_df)
```

```{r}
caret_df <- cnv_df |> 
  dplyr::filter(copykat.pred != "not.defined") |> 
  dplyr::mutate(copykat = ifelse(
    # use str_detect for test data
    copykat.pred == "diploid", "Normal", "Tumor"
  ))

caret::confusionMatrix(table(caret_df$marker_gene_classification, 
      caret_df$copykat))
```

Look at how many cells are aneuploid vs. diploid
Compare tumor vs. normal from manual to copykat using confusion matrix 


Try and repeat but with providing a baseline reference 
