---
title: "`SCPCL001114` - Exploration of gene set based methods for tumor cell assignment"
author: Ally Hawkins
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    code_folding: hide
---

## Introduction

In this notebook we attempt to identify tumor cells in `SCPCL001114` using the following orthogonal marker gene based methods: 

- Marker gene expression from `SCPCL000822` to inform an appropriate cut off for marker gene expression in `SCPCL000824`. 
- [`AUCell`](https://www.bioconductor.org/packages/release/bioc/vignettes/AUCell/inst/doc/AUCell.html) with marker genes and three EWS-FLI1 gene sets in both samples. 
- [`UCell`](https://carmonalab.github.io/UCell_demo/UCell_matrix_vignette.html#content) with marker genes and three EWS-FLI1 gene sets in both samples. 

Throughout this notebook, we will use `SCPCL000822` as a reference. 
We have classified tumor cells to be those identified as tumor cells by both `InferCNV` and `CopyKAT` and validated those classifications in `SCPCL000822_tumor-cell-validation.Rmd`. 

## Setup

```{r packages}
suppressPackageStartupMessages({
  # load required packages
  library(SingleCellExperiment)
  library(ggplot2)
})

# Set default ggplot theme
theme_set(
  theme_bw()
)

# quiet messages
options(readr.show_col_types = FALSE)
ComplexHeatmap::ht_opt(message = FALSE)
```


```{r base paths}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
repository_base <- rprojroot::find_root(rprojroot::is_git_root)

# The current data directory, found within the repository base directory
data_dir <- file.path(repository_base, "data", "current")
sample_dir <- file.path(data_dir, "SCPCP000015", "SCPCS000752")

# The path to this module
module_base <- file.path(repository_base, "analyses", "cell-type-ewings")
```

```{r}
# source in helper functions: plot_gene_heatmap() and plot_cnv_heatmap() 
# create_classification_df() and create_marker_gene_df()
validation_functions <- file.path(module_base, "scripts", "utils", "tumor-validation-helpers.R")
source(validation_functions)
```

```{r}
# Input files
sce_file <- file.path(sample_dir, "SCPCL001114_processed.rds")
marker_genes_file <- file.path(module_base, "references", "tumor-marker-genes.tsv")

# results from annotation workflow 
results_dir <- file.path(module_base, "results", "aucell_annotation", "SCPCS000752")
auc_results_file <- file.path(results_dir, "SCPCL001114_auc-classifications.tsv")
geneset_scores_file <- file.path(results_dir, "SCPCL001114_gene-set-scores.tsv")

# output files 
final_annotations_dir <- file.path(module_base, "results", "annotation_tables", "SCPCS000492")
fs::dir_create(final_annotations_dir)
final_annotations_file <- file.path(final_annotations_dir, "SCPCL000824_tumor-classifications.tsv.gz")

# reference files to use
ref_sce_file <- file.path(data_dir, "SCPCP000015", "SCPCS000490", "SCPCL000822_processed.rds")
ref_labels_file <- file.path(module_base, "results", "annotation_tables", "SCPCS000490", "SCPCL000822_tumor-classifications.tsv")
ref_geneset_scores_file <- file.path(module_base, "results", "cnv_annotation", "SCPCS000490", "SCPCL000822_gene-set-scores.tsv")
```

```{r}
# read in sce file 
sce <- readr::read_rds(sce_file)
auc_results_df <- readr::read_tsv(auc_results_file)
geneset_scores_df <- readr::read_tsv(geneset_scores_file)

# read in ref sce and ref annotations for comparing between samples 
# ref is SCPCL000822
ref_sce <- readr::read_rds(ref_sce_file)
ref_labels_df <- readr::read_tsv(ref_labels_file)
ref_geneset_df <- readr::read_tsv(ref_geneset_scores_file)
```

```{r}
# generate classification df to use for plots 
classification_df <- sce |> 
  scuttle::makePerCellDF(use.dimred = "UMAP") |> 
  # replace UMAP.1 with UMAP1
  dplyr::rename_with(
    \(x) stringr::str_replace(x, "^UMAP\\.", "UMAP")
  ) |>
  # get rid of excess columns
  dplyr::select(barcodes, UMAP1, UMAP2, singler_celltype_annotation) |> 
  # join with previous annotations, singler results, and gene set scores 
  dplyr::left_join(auc_results_df, by = "barcodes") |> 
  dplyr::left_join(geneset_scores_df, by = "barcodes")

# generate marker genes df
plot_markers_df <- create_marker_gene_df(
  sce,
  classification_df, 
  marker_genes_file
)
```

```{r}
# look at the raw sum of marker gene expression in both 822 and 824
# first create marker genes df for ref sce 
ref_classification_df <- ref_labels_df |> 
  dplyr::rename("barcodes" = "cell_barcode")

ref_markers_df <- create_marker_gene_df(sce = ref_sce, 
                                        classification_df = ref_classification_df,
                                        marker_genes_file) |> 
  dplyr::mutate(sample = "SCPCL000822")

# combine all marker gene data for both samples into one df 
combined_markers_df <- plot_markers_df |> 
  dplyr::select(barcodes, gene_symbol, gene_expression, transformed_gene_expression, sum_raw_exp, sum_transformed_exp) |> 
  dplyr::mutate(sample = "SCPCL001114") |> 
  dplyr::bind_rows(ref_markers_df)
```

```{r}
# total distribution
ggplot(combined_markers_df, aes(x = sum_raw_exp)) +
  geom_density() +
  facet_grid(rows = vars(sample))
```

```{r}
# create distribution 
density_data <- density(combined_markers_df$sum_raw_exp)
# find the local minima in the distribution
exp_cutoff <- optimize(approxfun(density_data$x, density_data$y), interval = c(1,10))$minimum
```


```{r}
# add new column with updated marker gene classification 
# use local minima from 822 to define 824
new_classification <- combined_markers_df |> 
  dplyr::filter(sample == "SCPCL001114") |> 
  dplyr::mutate(marker_gene_classification = dplyr::if_else(sum_raw_exp >= exp_cutoff, "Tumor", "Normal")) |> 
  dplyr::select(barcodes, marker_gene_classification) |> 
  unique()

# add new column to existing classification
classification_df <- classification_df |> 
  dplyr::left_join(new_classification)

# label cells based on new classifiation 
ggplot(classification_df, aes(x = UMAP1, y = UMAP2, color = marker_gene_classification)) +
  geom_point(alpha = 0.5, size = 0.5)
```

```{r}
# get geneset score from reference sce 
ref_geneset_df <- ref_geneset_df |> 
  dplyr::select(barcodes, starts_with("mean-")) |> 
  tidyr::pivot_longer(
    cols = starts_with("mean-"),
    names_to = "geneset",
    values_to = "mean_score"
  ) |> 
  dplyr::mutate(
    geneset = stringr::word(geneset, -1, sep = "-"),
    sample = "SCPCL000822 - reference"
  ) 

# plot gene set scores for each cell  
geneset_plot_df <- classification_df |> 
  dplyr::select(barcodes, UMAP1, UMAP2, ends_with("classification"), starts_with("mean-")) |> 
  tidyr::pivot_longer(
    cols = starts_with("mean-"),
    names_to = "geneset",
    values_to = "mean_score"
  ) |> 
  dplyr::mutate(
    geneset = stringr::word(geneset, -1, sep = "-")
  )

# join with gene set scores from 824 and plot distribution 
geneset_plot_df |> 
  dplyr::select(barcodes, geneset, mean_score) |> 
  dplyr::mutate(sample = "SCPCL001114") |> 
  dplyr::bind_rows(ref_geneset_df) |> 
  ggplot(aes(x = mean_score, color = sample)) +
  geom_density() +
  facet_grid(rows = vars(geneset))
```

## Compare AUCell classification to marker gene classification 

```{r}
classification_df <- classification_df |> 
  dplyr::mutate(
    marker_gene_classification = forcats::fct_relevel(marker_gene_classification, "Tumor"),
    auc_classification = forcats::fct_relevel(auc_classification, "Tumor")
  )

# compare using a confusion matrix
caret::confusionMatrix(
    table(
      classification_df$marker_gene_classification, 
      classification_df$auc_classification)
  ) 
```


## UCell 

```{r}
# get list of marker genes to add to GeneSets 
marker_genes <- readr::read_tsv(marker_genes_file, show_col_types = FALSE) |> 
  # account for genes being from multiple sources
  dplyr::select(cell_type, ensembl_gene_id, gene_symbol) |> 
  dplyr::distinct() |> 
  dplyr::filter(cell_type == "tumor") |> 
  dplyr::pull(ensembl_gene_id)

# create list to use for ucell of gene sets and marker genes
ucell_gene_sets <- c(markers = list(marker_genes)) |> 
  # only keep genes that are found in reference 
  purrr::map(\(geneset){
    intersect(geneset, rownames(sce))
  })

# run ucell on both ref (822) and 824
ref_ucell <- UCell::ScoreSignatures_UCell(counts(ref_sce), features = ucell_gene_sets)
new_ucell <- UCell::ScoreSignatures_UCell(counts(sce), features = ucell_gene_sets)
```

`UCell` returns a signature score for each gene set and does not calculate any thresholds for classification on it's own. 
We will look at the distribution of scores across both samples below and see if we can identify a good cut off to use for classification. 

```{r}
# plot distribution of ucell scores for both samples 
ref_ucell <- ref_ucell |> 
  as.data.frame() |> 
  tibble::rownames_to_column("barcodes") |> 
  dplyr::mutate(sample = "SCPCL000822")
  
ucell_df <- new_ucell |> 
  as.data.frame() |> 
  tibble::rownames_to_column("barcodes") |> 
  dplyr::mutate(sample = "SCPCL001114") |> 
  dplyr::bind_rows(ref_ucell) |> 
  tidyr::pivot_longer(ends_with("UCell"), 
                      names_to = "gene_list", 
                      values_to = "signature_score") |> 
  dplyr::mutate(
    gene_list = stringr::word(gene_list, 1, sep = "_")
  )
```

```{r}
ggplot(ucell_df, aes(x = signature_score, colour = sample)) +
  geom_density() +
  facet_grid(rows = vars(gene_list),
             scales = "free_y")
```

Boo this looks bad

## Consensus between AUCell and marker genes 

## Validation plots 

## Session info 

