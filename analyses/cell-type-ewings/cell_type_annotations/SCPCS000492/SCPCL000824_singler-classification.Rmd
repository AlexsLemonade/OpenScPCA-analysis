---
title: "`SCPCL000824` - Using `SingleR` for classification of tumor cells"
author: Ally Hawkins
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    code_folding: hide
---

## Introduction

This notebook looks at using `SingleR` to annotate tumor cells in `SCPCL000824`. 
We used three different references with `SingleR`: 

1. Both the full `BlueprintEncodeData` reference from `celldex` and `SCPCL000822` where cells are either annotated as tumor or normal. 
Ambiguous cells are removed from `SCPCL000822`. 
2. `SCPCL000822` where all tumor cells are labeled as tumor and all other cells keep the original annotation obtained from running `SingleR` as part of `scpca-nf`.  
3. `SCPCL000822` with tumor cells labeled as in #2 combined with the full `BlueprintEncodeData` reference. 


## Setup

```{r packages}
suppressPackageStartupMessages({
  # load required packages
  library(SingleCellExperiment)
  library(ggplot2)
})

# Set default ggplot theme
theme_set(
  theme_bw()
)

# quiet messages
options(readr.show_col_types = FALSE)
ComplexHeatmap::ht_opt(message = FALSE)
```


```{r base paths}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
repository_base <- rprojroot::find_root(rprojroot::is_git_root)

# The current data directory, found within the repository base directory
data_dir <- file.path(repository_base, "data", "2024-05-01")
sample_dir <- file.path(data_dir, "SCPCP000015", "SCPCS000492")

# The path to this module
module_base <- file.path(repository_base, "analyses", "cell-type-ewings")
```

```{r}
# source in helper functions: plot_gene_heatmap() and plot_cnv_heatmap() 
# create_classification_df() and create_marker_gene_df()
validation_functions <- file.path(module_base, "scripts", "utils", "tumor-validation-helpers.R")
source(validation_functions)

# source in helper functions for make_jaccard_matrix() and jaccard()
jaccard_functions <- file.path(module_base, "scripts", "utils", "jaccard-functions.R")
source(jaccard_functions)
```

```{r}
# Input files
sce_file <- file.path(sample_dir, "SCPCL000824_processed.rds")
marker_genes_file <- file.path(module_base, "references", "tumor-marker-genes.tsv")

# annotations from SCPCL000824_tumor-gene-expression-exploration.Rmd
annotations_dir <- file.path(module_base, "cell_type_annotations", "SCPCS000492")
annotations_file <- file.path(annotations_dir, "SCPCL000824_tumor-classifications.tsv.gz")

# gene set scores to use for validation 
results_dir <- file.path(module_base, "results", "annotate_tumor_cells_output", "SCPCS000492")
geneset_scores_file <- file.path(results_dir, "SCPCL000824_gene-set-scores.tsv")

# singler results 
full_singler_results <- file.path(module_base, "scratch", "SingleR", "SCPCL000824_singler-results.rds")
singler_annotations_file <- file.path(annotations_dir, "SCPCL000824_singler-classifications.tsv.gz")
```

```{r}
# read in sce file 
sce <- readr::read_rds(sce_file)

# read in annotations
annotations_df <- readr::read_tsv(annotations_file)
singler_annotations_df <- readr::read_tsv(singler_annotations_file) |> unique()

# read in full singler results 
singler_results_list <- readr::read_rds(full_singler_results)

# read in gene set scores
geneset_scores_df <- readr::read_tsv(geneset_scores_file)
```

## Define functions 

```{r}
# function to plot jaccard matrices to compare one set of annotations to other methods 
# `annotation_column` will be the columns and will be compared to each method listed in `methods_to_compare` 
plot_jaccard <- function(classification_df,
                         annotation_column, # single column of annotations to compare to all methods
                         methods_to_compare, # list of methods to compare to annotations
                         column_title, # title for columns
                         legend_match # what legend to keep, should be a name in `methods_to_compare`
){
  
  # create jaccard matrices 
  jaccard_matrices <- methods_to_compare |>
    purrr::map(\(name) {
      make_jaccard_matrix(
        classification_df,
        annotation_column,
        name
      )
    })
  
  heatmap <- make_heatmap_list(jaccard_matrices, column_title, legend_match)
  
  return(heatmap)
  
}
```


```{r}
# generate classification df to use for plots 
classification_df <- sce |> 
  scuttle::makePerCellDF(use.dimred = "UMAP") |> 
  # replace UMAP.1 with UMAP1
  dplyr::rename_with(
    \(x) stringr::str_replace(x, "^UMAP\\.", "UMAP")
  ) |>
  # get rid of excess columns
  dplyr::select(barcodes, UMAP1, UMAP2, singler_celltype_annotation) |> 
  # join with previous annotations, singler results, and gene set scores 
  dplyr::left_join(annotations_df, by = c("barcodes" = "cell_barcode")) |> 
  dplyr::left_join(singler_annotations_df, by = "barcodes") |> 
  dplyr::left_join(geneset_scores_df, by = "barcodes") |>
  # get the top cell types for each classification method for plotting later 
  dplyr::mutate(
    across(
      ends_with("_classification"),
      \(x) {
        x |>
          forcats::fct_lump_n(7, other_level = "All remaining cell types", ties.method = "first") |>
          forcats::fct_infreq() |>
          forcats::fct_relevel("All remaining cell types", after = Inf)
      },
      .names = "{.col}_lumped"
    )
  )
```

## SingleR results 

### UMAPs of cell assignments 

The first thing we will do is look at the annotated cell types on a UMAP. 
The top 7 cell types are shown for each reference used and all other cells are lumped together. 

```{r}
# list of columns with singler results for UMAPs
singler_annotation_columns <- c(
  "blueprint_tumor_classification_lumped",
  "updated_singler_classification_lumped",
  "updated_singler_blueprint_classification_lumped"
)

singler_annotation_columns |> 
  purrr::map(\(annotation_column){
    ggplot(
    classification_df,
    aes(x = UMAP1, y = UMAP2, color = .data[[annotation_column]])
  ) +
    # set points for all "other" points
    geom_point(
      data = dplyr::select(
        classification_df, -.data[[annotation_column]]
      ),
      color = "gray80",
      alpha = 0.5,
      size = 0.5
    ) +
    # set points for desired cell type
    geom_point(size = 0.5, alpha = 0.5) +
    facet_wrap(
      vars(.data[[annotation_column]]),
      ncol = 3
    ) +
    scale_color_brewer(palette = "Dark2") +
    # remove axis numbers and background grid
    scale_x_continuous(labels = NULL, breaks = NULL) +
    scale_y_continuous(labels = NULL, breaks = NULL) +
    guides(
      color = guide_legend(
        title = "Cell types",
        # more visible points in legend
        override.aes = list(
          alpha = 1,
          size = 1.5
        )
      )
    )
  })
```

It appears that most cells in that bottom group of cells are being called tumor cells regardless of the reference that is used. 
The major differences here are in how the normal cells are labeled. 
For right now, let's focus on just identifying the tumor cells and see how similar each of the references are to each other before we compare to the other methods that we have used. 

### Compare tumor cell annotations between references used 

```{r}
methods <- c(
    "blueprint_tumor_classification_lumped",
    "updated_singler_classification_lumped",
    "updated_singler_blueprint_classification_lumped"
  ) |> 
  purrr::set_names("Blueprint", "Original", "Original and Blueprint")



heatmap_list <- methods |>
  purrr::imap(\(method, name){
    
    plot_jaccard(classification_df,
                 annotation_column = method, # single column of annotations to compare to all methods
                 methods_to_compare = methods, # list of methods to compare to annotations
                 column_title = name,
                 legend_match = "Original" # what legend to keep, should be a name in `methods_to_compare`
    )
    
  }) 
heatmap_list
```

Upset plot looking at overlapping tumor cells called by all three 

```{r}
tumor_cells <- list(
  "Blueprint" = classification_df$barcodes[classification_df$blueprint_tumor_classification == "Tumor"],
  "Original" = classification_df$barcodes[classification_df$updated_singler_classification == "Tumor"],
  "Original and Blueprint" = classification_df$barcodes[classification_df$updated_singler_blueprint_classification == "Tumor"]
)

UpSetR::upset(UpSetR::fromList(tumor_cells), order.by = "freq") |> print()
```


```{r}
classification_df <- classification_df |> 
  dplyr::mutate(singler_consensus_call = dplyr::case_when(
    blueprint_tumor_classification == "Tumor" & updated_singler_classification == "Tumor" & updated_singler_blueprint_classification == "Tumor" ~ "Tumor",
    blueprint_tumor_classification == "Tumor" | updated_singler_classification == "Tumor" | updated_singler_blueprint_classification == "Tumor" ~ "Ambiguous",
    .default = "Normal"
  )) 

ggplot(classification_df, aes(x = UMAP1, y = UMAP2, color = singler_consensus_call)) +
  geom_point(alpha = 0.5, size = 0.5)
```


Compare normal calls to original SingleR normal calls 
```{r}
original_celltypes <- classification_df$singler_celltype_annotation |> unique()
normal_celltypes <- classification_df |> 
  dplyr::filter(updated_singler_blueprint_classification_lumped != "Tumor") |> 
  dplyr::pull(updated_singler_blueprint_classification_lumped) |> 
  unique()

shared_celltypes <- intersect(original_celltypes, normal_celltypes)

caret_df <- classification_df |> 
  dplyr::filter(singler_celltype_annotation %in% shared_celltypes |
                updated_singler_blueprint_classification %in% shared_celltypes)
  
caret::confusionMatrix(
    table(
      caret_df$singler_celltype_annotation, 
      caret_df$updated_singler_blueprint_classification)
  )s
```


### Compare tumor cell annotations with `SingleR` to marker gene based methods 


```{r}
 original_methods <- c(
    "updated_marker_gene_classification",
    "auc_classification",
    "ucell_classification"
  ) |> 
  purrr::set_names("Marker genes", "AUCell", "UCell")

heatmap_list <- annotations_to_plot |> 
  purrr::walk(\(annotation_column) {plot_jaccard(classification_df, annotation_column, original_methods)})
```

```{r}
methods <- c(
    "blueprint_tumor_classification_lumped",
    "updated_singler_classification_lumped",
    "updated_singler_blueprint_classification_lumped"
  ) |> 
  purrr::set_names("Blueprint", "Original", "Original and Blueprint")

heatmap_list <- plot_jaccard(classification_df, "singler_celltype_annotation", methods)
```

Validate marker gene and gene set expression across all three methods 

```{r}
plot_markers_df <- create_marker_gene_df(
  sce,
  classification_df, 
  marker_genes_file
)
```

```{r}
# create a density plot showing the distribution of marker gene expression across classification methods 
marker_density_df <- plot_markers_df |>
  tidyr::pivot_longer(
    cols = ends_with("classification"),
    names_to = "method",
    values_to = "classification"
  ) |> 
  dplyr::mutate(
    method = dplyr::case_when(
      method == "marker_gene_classification" ~ "Marker genes only",
      method == "updated_marker_gene_classification" ~ "Marker gene cutoff from 822",
      method == "auc_classification" ~ "AUCell",
      method == "ucell_classification" ~ "UCell",
      method == "blueprint_tumor_classification" ~ "Blueprint",
      method == "updated_singler_classification" ~ "Original SingleR with tumor",
      method == "updated_singler_blueprint_classification" ~ "Tumor + SingleR + Blueprint"
    ),
    classification = dplyr::if_else(classification == "Tumor", "Tumor", "Other")
  ) 

ggplot(marker_density_df, aes(x = sum_transformed_exp, color = classification)) +
  geom_density() +
  facet_wrap(vars(method))
```


```{r}
# plot gene set scores for each cell  
geneset_plot_df <- classification_df |> 
  dplyr::select(barcodes, UMAP1, UMAP2, ends_with("classification"), starts_with("mean-")) |> 
  tidyr::pivot_longer(
    cols = starts_with("mean"),
    names_to = "geneset",
    values_to = "mean_score"
  ) |> 
  dplyr::mutate(
    geneset = stringr::word(geneset, -1, sep = "-")
  ) |> 
  tidyr::pivot_longer(
    cols = ends_with("classification"),
    names_to = "method",
    values_to = "classification"
  ) |> 
  dplyr::mutate(
    method = dplyr::case_when(
      method == "marker_gene_classification" ~ "Marker genes only",
      method == "updated_marker_gene_classification" ~ "Marker gene cutoff from 822",
      method == "auc_classification" ~ "AUCell",
      method == "ucell_classification" ~ "UCell",
      method == "blueprint_tumor_classification" ~ "Blueprint",
      method == "updated_singler_classification" ~ "Original SingleR with tumor",
      method == "updated_singler_blueprint_classification" ~ "Tumor + SingleR + Blueprint"
    ),
    classification = dplyr::if_else(classification == "Tumor", "Tumor", "Other")
    ) 
  
ggplot(geneset_plot_df, aes(x = mean_score, color = classification)) +
  geom_density(bw = 0.05) +
  facet_grid(rows = vars(method), 
             cols = vars(geneset))

```

Look at consensus across all three references. 
For normal cells, identify some top markers and see if they are expressed in that group of cells compared to all other cells. 
confusion matrix across all shared normal cell types between OG singleR and new singleR

