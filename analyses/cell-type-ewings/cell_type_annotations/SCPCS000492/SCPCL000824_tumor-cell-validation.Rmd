---
title: "SCPCL000824 - Validation of tumor cells"
author: Ally Hawkins
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
---

## Introduction

In this notebook we compare tumor cell annotations obtained from marker genes, `CopyKAT`, and `InferCNV` to identify a group of tumor cells we are confident in. 

- First we look at the cells that are annotated as tumor cells by each method. 
Using this information, we call any cell that is annotated as a tumor cell by both `CopyKAT` and `InferCNV` as a tumor cell. 
- We then validate that these are in fact tumor cells by doing the following: 
  - Looking at marker gene expression. 
  - Looking at expression of EWS-FLI1 target gene sets. 
  - Confirming presence of known CNVs in Ewing sarcoma

## Setup

```{r packages}
suppressPackageStartupMessages({
  # load required packages
  library(SingleCellExperiment)
  library(ggplot2)
})

# Set default ggplot theme
theme_set(
  theme_bw()
)
```


```{r base paths}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
repository_base <- rprojroot::find_root(rprojroot::is_git_root)

# The current data directory, found within the repository base directory
data_dir <- file.path(repository_base, "data", "2024-05-01")
sample_dir <- file.path(data_dir, "SCPCP000015", "SCPCS000492")

# The path to this module
module_base <- file.path(repository_base, "analyses", "cell-type-ewings")
```

```{r}
# source in helper functions: plot_gene_heatmap() and plot_cnv_heatmap() 
# create_classification_df() and create_marker_gene_df()
validation_functions <- file.path(module_base, "scripts", "utils", "tumor-validation-helpers.R")
source(validation_functions)

# source in helper functions: make_jaccard_matrix() and jaccard() 
jaccard_functions <- file.path(module_base, "scripts", "utils", "jaccard-functions.R")
source(jaccard_functions)
```

```{r}
# Input files
sce_file <- file.path(sample_dir, "SCPCL000824_processed.rds")
marker_genes_file <- file.path(module_base, "references", "tumor-marker-genes.tsv")

# results from annotation workflow 
results_dir <- file.path(module_base, "results", "annotate_tumor_cells_output", "SCPCS000492")

marker_gene_results_file <- file.path(results_dir, "SCPCL000824_tumor-normal-classifications.tsv")
copykat_predictions_file <- file.path(results_dir, "SCPCL000824_copykat-classifications.tsv")

infercnv_predictions_file <- file.path(results_dir, "SCPCL000824_infercnv-classifications.tsv")
infercnv_metadata_file <- file.path(results_dir, "infercnv", "SCPCL000824_cnv-metadata.tsv")

geneset_scores_file <- file.path(results_dir, "SCPCL000824_gene-set-scores.tsv")

# output files 
final_annotations_dir <- file.path(module_base, "cell_type_annotations", "SCPCS000492")
fs::dir_create(final_annotations_dir)
final_annotations_file <- file.path(final_annotations_dir, "SCPCL000824_tumor-classifications.tsv")
```

```{r}
# read in sce file 
sce <- readr::read_rds(sce_file)
```

```{r}
# generate classification df 
classification_df <- create_classification_df(
  sce,
  marker_gene_results_file,
  copykat_predictions_file, 
  infercnv_predictions_file,
  infercnv_metadata_file,
  geneset_scores_file
)
```



## Identify tumor cell population 

Below is a UMAP showing which cells are labeled as tumor cells using each of the various classification methods. 

```{r}
# plot tumor cells for each classification method 
tumor_umap_df <- classification_df |> 
  dplyr::select(barcodes, UMAP1, UMAP2, marker_gene_classification, copykat_classification, cnv_proportion_classification) |> 
  tidyr::pivot_longer(
    cols = ends_with("classification"),
    names_to = "method",
    values_to = "classification"
  ) |> 
  dplyr::mutate(
    method = dplyr::case_when(
      method == "marker_gene_classification" ~ "Marker genes only",
      method == "copykat_classification" ~ "CopyKAT - no reference",
      method == "cnv_proportion_classification" ~ "InferCNV proportion"
    )
  )

ggplot(tumor_umap_df, aes(x = UMAP1, UMAP2, color = classification)) +
  geom_point(size = 0.5, alpha = 0.5) +
  facet_wrap(vars(method))
```

```{r}
# plot tumor cells for each classification method 
geneset_plot_df <- classification_df |> 
  dplyr::select(barcodes, UMAP1, UMAP2, ends_with("classification"), starts_with("scaled_mean")) |> 
  tidyr::pivot_longer(
    cols = starts_with("scaled_mean"),
    names_to = "geneset",
    values_to = "mean_score"
  ) |> 
  dplyr::mutate(
    geneset = stringr::word(geneset, -1, sep = "-")
  )

ggplot(geneset_plot_df, aes(x = UMAP1, UMAP2, color = mean_score)) +
  geom_point(size = 0.5, alpha = 0.5) +
  facet_wrap(vars(geneset)) +
  scale_color_viridis_c()
```

Add geneset classification 

```{r}
# any cell that has > 0 expression of at least one geneset 
classification_df <- classification_df |>
  dplyr::mutate(
    geneset_classification = dplyr::if_else(
      `scaled_mean-RIGGI` > 0 & `scaled_mean-ZHANG` > 0 & `scaled_mean-SILIGAN` > 0,
      "Tumor",
      "Normal"
    ))
```


Compare gene set classification to marker gene classification 
```{r}
classification_columns <- c(
  "copykat_classification",
  "cnv_proportion_classification",
  "geneset_classification"
)

# create jaccard matrices for SingleR and CellAssign compared to tumor/normal 
jaccard_matrices <- classification_columns |>
  purrr::map(\(name) {
    make_jaccard_matrix(
      classification_df,
      "marker_gene_classification",
      name
    )
  }) |> 
  purrr::set_names("CopyKAT", "InferCNV", "Gene set")
```

```{r}
# Set heatmap padding option
heatmap_padding <- 0.2
ComplexHeatmap::ht_opt(TITLE_PADDING = grid::unit(heatmap_padding, "in"))

# list of heatmaps looking at SingleR/ CellAssign vs tumor/normal 
heatmap <- jaccard_matrices |>
  purrr::imap(
    \(classification_mat, classification_method) {
      ComplexHeatmap::Heatmap(
        t(classification_mat), # transpose because matrix rows are in common & we want a vertical arrangement
        col = circlize::colorRamp2(c(0, 1), colors = c("white", "darkslateblue")),
        border = TRUE,
        ## Row parameters
        cluster_rows = TRUE,
        row_title = classification_method,
        row_title_gp = grid::gpar(fontsize = 12),
        row_title_side = "left",
        row_names_side = "left",
        row_dend_side = "right",
        row_names_gp = grid::gpar(fontsize = 10),
        ## Column parameters
        cluster_columns = FALSE,
        column_title = "Marker genes",
        column_title_gp = grid::gpar(fontsize = 12),
        column_names_side = "bottom",
        column_names_gp = grid::gpar(fontsize = 10),
        column_names_rot = 90,
        ## Legend parameters
        heatmap_legend_param = list(
          title = "Jaccard index",
          direction = "vertical",
          legend_width = unit(1.5, "in")
        ),
        show_heatmap_legend = classification_method == "CopyKAT",
      )
    }) |>
  # concatenate vertically into HeatmapList object
  purrr::reduce(ComplexHeatmap::`%v%`) |>
  ComplexHeatmap::draw(
    heatmap_legend_side = "right",
    # add a margin to the heatmap so labels don't get cut off
    padding = unit(c(2, 20, 2, 2), "mm")
  )
```

Add in classifications for geneset vs. CNV 

```{r}
classification_df <- classification_df |>
  dplyr::mutate(
    exp_classification = dplyr::case_when(
      marker_gene_classification == "Normal" & geneset_classification == "Normal" ~ "Normal",
      marker_gene_classification == "Tumor" & geneset_classification == "Tumor" ~ "Tumor",
      .default = "Ambiguous"
    ), 
    all_cnv_classification = dplyr::case_when(
      copykat_classification == "Normal" & cnv_proportion_classification == "Normal" ~ "Normal",
      copykat_classification == "Normal" & cnv_proportion_classification == "Reference"~ "Normal",
      copykat_classification == "Tumor" & cnv_proportion_classification == "Tumor" ~ "Tumor",
      .default = "Ambiguous"
    )
  )
```


```{r}
geneset_plot_df |> 
  tidyr::pivot_longer(
    cols = ends_with("classification"),
    names_to = "method",
    values_to = "classification"
  ) |> 
  ggplot(aes(x = mean_score, color = classification)) +
  geom_density(bw = 0.05) +
  facet_grid(rows = vars(method), 
             cols = vars(geneset))
```

```{r}
# generate marker genes df
plot_markers_df <- create_marker_gene_df(
  classification_df, 
  marker_genes_file
)

# calculate sum of the scaled gene expression values for plotting 
marker_density_df <- plot_markers_df |>
  tidyr::pivot_longer(
    cols = ends_with("classification"),
    names_to = "method",
    values_to = "classification"
  ) |> 
  dplyr::mutate(
    method = dplyr::case_when(
      method == "marker_gene_classification" ~ "Marker genes only",
      method == "copykat_classification" ~ "CopyKAT - no reference",
      method == "cnv_proportion_classification" ~ "InferCNV proportion",
      method == "exp_classification" ~ "Expression combined",
      method == "all_cnv_classification" ~ "CopyKAT and InferCNV",
      method == "geneset_classification" ~ "EWS-FLI1 Gene set"
    )
  )

ggplot(marker_density_df, aes(x = sum_exp, color = classification)) +
  geom_density() +
  facet_wrap(vars(method))
```


```{r}
ggplot(classification_df, aes(x = UMAP1, y = UMAP2, color = geneset_classification)) +
  geom_point(size = 0.5, alpha = 0.5)
```



CNV heatmap annotated by copykat and marker gene prediction, two annotation columns 

```{r}
annotation_df <- classification_df |> 
  dplyr::select(barcodes, ends_with("classification")) |> 
  unique() 

# need to make a new annotation, since we want to annotate the rows here 
annotation <- ComplexHeatmap::rowAnnotation(exp_classification = annotation_df$exp_classification,
                                            all_cnv_classification = annotation_df$all_cnv_classification)

# plot gains in cnv
plot_cnv_heatmap(classification_df,
                 cnv_col = "proportion_scaled_dupli",
                 annotation = annotation,
                 legend_title = "Copy number \ngain")
```

```{r}
# plot gains in cnv
plot_cnv_heatmap(classification_df,
                 cnv_col = "proportion_scaled_loss",
                 annotation = annotation,
                 legend_title = "Copy number \nloss")
```


Density plot with mean proportion CNV from InferCNV on x-axis, colored by prediction, faceted by classification method 

```{r}
classification_df |> 
  dplyr::select(barcodes, UMAP1, UMAP2, ends_with("classification"), mean_cnv_proportion) |> 
  tidyr::pivot_longer(
    cols = ends_with("classification"),
    names_to = "method",
    values_to = "classification"
  ) |> 
  ggplot(aes(x = mean_cnv_proportion, color = classification)) +
  geom_density(bw = 0.05) +
  facet_grid(rows = vars(method))
```


Mean InferCNV proportion on x-axis, mean copyKAT proportion on y-axis, color by scaled sum of marker gene expression 

```{r}
cnv_prop_df <- classification_df |> 
  dplyr::select(barcodes, ends_with("classification"), starts_with("scaled_mean"), mean_cnv_proportion, mean_cnv_detection) |> 
  tidyr::pivot_longer(
    cols = starts_with("scaled_mean"),
    names_to = "geneset",
    values_to = "mean_score"
  ) |> 
  dplyr::mutate(
    geneset = stringr::word(geneset, -1, sep = "-")
  ) 

ggplot(cnv_prop_df, aes(x = mean_cnv_proportion, y = abs(mean_cnv_detection), color = mean_score)) +
  geom_point(size = 0.5, alpha = 0.5) +
  facet_wrap(vars(geneset)) +
  scale_color_viridis_c()
```

```{r}
ggplot(cnv_prop_df, aes(x = mean_score, y = abs(mean_cnv_detection))) +
  geom_point(size = 0.5, alpha = 0.5) +
  facet_wrap(vars(geneset)) +
  scale_color_viridis_c()
```

faceted density plot with marker gene expression on x axis, colored by copykat and infercnv prediction and faceted by marker gene 

```{r}
geneset_scores_df |> 
  dplyr::pivot

ggplot(geneset_scores_df, aes(x = mean_score, color = ))
```



use SingleR to classify as tumor/normal using SCPCS000490 

correlation of geneset score and marker gene score 
```{r}
geneset_plot_df |> 
  
  dplyr::left_join(marker_density_df) |> 
  ggplot(aes(x = sum_exp, y = mean_score)) +
    facet_wrap()
```

