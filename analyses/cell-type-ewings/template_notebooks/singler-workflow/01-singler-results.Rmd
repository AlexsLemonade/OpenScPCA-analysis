---
title: "Summary of tumor cell classification with `SingleR` for `r params$library_id`"
author: Ally Hawkins
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    code_folding: "hide"
params:
  library_id: NULL
  sce_file: NULL
  singler_results_file: NULL
  geneset_scores_file: NULL
  marker_genes_file: NULL
---

This report summarizes the classification of `r params$library_id` using the following approach: 

- Tumor cells were identified by using `AUCell`. 
These cells are labeled as `tumor_original`. 
- All other cells were labeled using `SingleR` with a combination of three references: 
  - All tumor cells annotated by `AUCell` for all other libraries in `SCPCP000015`. 
  Any cells that are labeled as tumor using this reference are labeled as `tumor_new`. 
  - `BlueprintEncodeData` from `celldex`
  - `HumanPrimaryCellAtlasData` from `celldex`


## Setup

```{r}
# check that sce and results files exist 
stopifnot(
  "sce file does not exist" = file.exists(params$sce_file),
  "SingleR results file does not exist" = file.exists(params$singler_results_file), 
  "Gene set scores file does not exist" = file.exists(params$geneset_scores_file),
  "Marker genes file does not exist" = file.exists(params$marker_genes_file)
)
```


```{r packages}
suppressPackageStartupMessages({
  # load required packages
  library(SingleCellExperiment)
  library(ggplot2)
})

# Set default ggplot theme
theme_set(
  theme_bw()
)

# quiet messages
options(readr.show_col_types = FALSE)
ComplexHeatmap::ht_opt(message = FALSE)
```


```{r base paths}
# The path to this module
module_base <- rprojroot::find_root(rprojroot::is_renv_project)

# source in helper functions: plot_gene_heatmap() and plot_cnv_heatmap() 
# create_classification_df() and create_marker_gene_df()
validation_functions <- file.path(module_base, "scripts", "utils", "tumor-validation-helpers.R")
source(validation_functions)
```

```{r}
# Read in files
sce <- readr::read_rds(params$sce_file)
singler_results_df <- readr::read_tsv(params$singler_results_file)
geneset_scores_df <- readr::read_tsv(params$geneset_scores_file)
```

## Prep for plots

```{r}
# original library annotation 
orig_tumor <- glue::glue("tumor-{params$library_id}")

# generate classification df to use for plots 
classification_df <- sce |> 
  scuttle::makePerCellDF(use.dimred = "UMAP") |> 
  # replace UMAP.1 with UMAP1
  dplyr::rename_with(
    \(x) stringr::str_replace(x, "^UMAP\\.", "UMAP")
  ) |>
  # get rid of excess columns
  dplyr::select(barcodes, UMAP1, UMAP2) |> 
  # join with previous annotations, singler results, and gene set scores 
  dplyr::left_join(singler_results_df, by = "barcodes") |> 
  dplyr::left_join(geneset_scores_df, by = "barcodes") |> 
  dplyr::mutate(
    # first remove other library IDs from tumor annotations
    # we only care about whether or not it was from the original library or a new library
    singler_tumor_annotation = dplyr::case_when(
      singler_tumor_annotation == orig_tumor ~ "tumor_original",
      stringr::str_detect(singler_tumor_annotation, "tumor") ~ "tumor_new",
      .default = singler_tumor_annotation
    ),
    # get the top cell types for plotting later 
    singler_tumor_annotation_lumped = dplyr::if_else(is.na(singler_tumor_annotation), "Not labeled", singler_tumor_annotation) |>
          # there are warnings because we have some that have less than 7 cell types (ones that only did tumor/normal)
          # this is why we ignore warnings in this chunk 
          forcats::fct_lump_n(7, other_level = "All remaining cell types", ties.method = "first") |>
          forcats::fct_infreq() |>
          forcats::fct_relevel("All remaining cell types", after = Inf), 
    # make a label that combines tumor_new with tumor_original
    singler_combined_tumor = dplyr::if_else(
      singler_tumor_annotation_lumped %in% c("tumor_original", "tumor_new"), 
      "tumor", 
      singler_tumor_annotation_lumped
      ) |> 
      forcats::fct_relevel("tumor", after = 0) |> 
      forcats::fct_relevel("All remaining cell types", after = Inf),
    # make a label that is just tumor or normal
    tumor_normal_classification = dplyr::if_else(singler_combined_tumor == "tumor", "tumor", "normal") |> 
      forcats::fct_relevel("tumor", after = 0)
  )
```


```{r}
# read in marker genes table 
marker_genes_df <- readr::read_tsv(params$marker_genes_file, show_col_types = FALSE) |> 
  # account for genes being from multiple sources
  dplyr::select(cell_type, ensembl_gene_id, gene_symbol) |> 
  dplyr::distinct()

# get list of all cell types found
cell_types <- unique(marker_genes_df$cell_type)

# get the sum of expression of all genes for each cell type
gene_exp_df <- cell_types |> 
  purrr::map(\(type){
    calculate_sum_markers(marker_genes_df, type)
  }) |> 
  purrr::reduce(dplyr::inner_join, by = "barcodes")

# join sum expression columns with classification df 
classification_df <- classification_df |> 
  dplyr::left_join(gene_exp_df)
```

```{r}
# get columns that correspond to marker genes and gene sets to help with plotting later 
marker_gene_columns <- colnames(classification_df)[which(endsWith(colnames(classification_df), "_sum"))]
geneset_columns <- colnames(classification_df)[which(startsWith(colnames(classification_df), "mean-"))]
```

## UMAP of all cell type annotations 

Here we show the annotated cell types on a UMAP. 
The top 7 cell types are shown for each reference used and all other cells are lumped together. 

```{r, fig.height=8, fig.width=8}
ggplot(classification_df, aes(x = UMAP1, y = UMAP2, color = singler_tumor_annotation_lumped)) +
  # set points for all "other" points
  geom_point(
    data = dplyr::select(
      classification_df, -singler_tumor_annotation_lumped
    ),
    color = "gray80",
    alpha = 0.5,
    size = 0.1
  ) +
  # set points for desired cell type
  geom_point(size = 0.1, alpha = 0.5) +
  facet_wrap(
    vars(singler_tumor_annotation_lumped),
    ncol = 3
  ) +
  scale_color_brewer(palette = "Dark2") +
  # remove axis numbers and background grid
  scale_x_continuous(labels = NULL, breaks = NULL) +
  scale_y_continuous(labels = NULL, breaks = NULL) +
  guides(
    color = guide_legend(
      title = "Cell type",
      # more visible points in legend
      override.aes = list(
        alpha = 1,
        size = 1.5
      )
    )) +
  theme(
        legend.position = c(0.67, 0.33),
        legend.justification = c("left", "top"),
        legend.title.align = 0.5,
        # use slightly smaller legend text, which helps legend fit and prevents
        #  long wrapped labels from bunching up
        legend.text = element_text(size = rel(0.85)),
        legend.key.height = unit(0.75, "cm"),
        aspect.ratio = 1
      )
```

## Evaluate output from `SingleR`

The next three sections will evaluate the annotations by looking at expression of marker genes and gene set scores. 

The gene expression for all marker genes for tumor cells, endothelial cells, mesenchymal-like cells, and immune cells was summed together for each cell. 
Marker genes were obtained from [Visser et al.](https://doi.org/10.1158/2767-9764.CRC-23-0027). 

Gene set scores are determined by calculating the mean expression of all genes in a given gene set. 
Scores are calculated for the following gene sets from `MsigDb`:

  - [`ZHANG_TARGETS_OF_EWSR1_FLI1_FUSION`](https://www.gsea-msigdb.org/gsea/msigdb/human/geneset/ZHANG_TARGETS_OF_EWSR1_FLI1_FUSION.html)
  - [`RIGGI_EWING_SARCOMA_PROGENITOR_UP`](https://www.gsea-msigdb.org/gsea/msigdb/human/geneset/RIGGI_EWING_SARCOMA_PROGENITOR_UP.html?ex=1)
  - [`SILIGAN_TARGETS_OF_EWS_FLI1_FUSION_DN`](https://www.gsea-msigdb.org/gsea/msigdb/cards/SILIGAN_TARGETS_OF_EWS_FLI1_FUSION_DN)

For both marker gene expression and gene set scores, the following plots will be shown: 

- Heatmap showing gene expression or gene set scores across all cells. 
Here the rows correspond to the gene list and the columns are the cells. 
The annotations are shown below the heatmap. 
- Density plot showing gene expression or gene set scores across all cells. 
Each row is a cell type and the expression or score is plotted on the x-axis. 


### Tumor vs. Normal 

In this section we show just the cells that are considered tumor (including both `tumor_original` and `tumor_new`) and normal, lumping all non-tumor cell types together. 

**Marker gene expression**

```{r}
full_celltype_heatmap(classification_df, marker_gene_columns, "tumor_normal_classification")
```


```{r}
plot_density(classification_df,
             "tumor_sum",
             "tumor_normal_classification")
```

**Gene set scores**

```{r}
full_celltype_heatmap(classification_df, geneset_columns, "tumor_normal_classification")
```

```{r}
geneset_columns |> 
  purrr::map(\(column){
    plot_density(classification_df,
                 column,
                 "tumor_normal_classification")
  })
```


### Tumor vs. all other cell types 

In this section we show all tumor cells together (including both `tumor_original` and `tumor_new`) and the top 5 most represented normal cell types.

**Marker gene expression** 

```{r}
full_celltype_heatmap(classification_df, marker_gene_columns, "singler_combined_tumor")
```

```{r}
marker_gene_columns |> 
  purrr::map(\(column){
    plot_density(classification_df,
                 column,
                 "singler_combined_tumor")
  })
```


**Gene set scores**

```{r}
full_celltype_heatmap(classification_df, geneset_columns, "singler_combined_tumor")
```

```{r}
geneset_columns |> 
  purrr::map(\(column){
    plot_density(classification_df,
                 column,
                 "singler_combined_tumor")
  })
```

### Compare newly annotated tumor cells to existing tumor cells

In this section we show both tumor cell types, `tumor_original` and `tumor_new`, separately and the top 5 most represented normal cell types.

**Marker gene expression**

```{r}
full_celltype_heatmap(classification_df, marker_gene_columns, "singler_tumor_annotation_lumped")
```


```{r}
marker_gene_columns |> 
  purrr::map(\(column){
    plot_density(classification_df,
                 column,
                 "singler_tumor_annotation_lumped")
  })
```


**Gene set scores**

```{r}
full_celltype_heatmap(classification_df, geneset_columns, "singler_tumor_annotation_lumped")
```

```{r}
geneset_columns |> 
  purrr::map(\(column){
    plot_density(classification_df,
                 column,
                 "singler_tumor_annotation_lumped")
  })
```


## Session Info

```{r session info}
# record the versions of the packages used in this analysis and other environment information
sessionInfo()
```


