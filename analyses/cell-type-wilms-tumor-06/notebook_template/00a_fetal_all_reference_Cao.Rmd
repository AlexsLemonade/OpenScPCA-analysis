---
title: "Reference label transfer exploration for `r params$sample_id`"
author: "Maud PLASCHKA"
date: '2024-08-07'
params:
  current: "2024-07-08"
  scpca_project_id: "SCPCP000006"
  sample_id: "SCPCS000176"
  seed: 12345
output: 
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
    highlight: pygments
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message=FALSE,
                      warnings=FALSE)
```


## Introduction

The aim is to find an appropriate reference to perform label transfer as a step of the annotation of the Wilms tumor dataset for the sample `param$sample_id` = 

```{r}
params$sample_id
```

The use of the right reference is crucial. 
It is recommended that the cell types in the reference is representative to the cell types to be annotated in the query.

Wilms tumors can contain up to three histologies that resemble fetal kidney: blastema, stroma, and epithelia [1-2].
Because of their histological similarity to fetal kidneys, Wilms tumors are thought to arise from developmental derangements in embryonic renal progenitors.

We thus decided to test and compare fetal (kidney) references that could be use in the analysis module.
You can find below the three workflow/reference that we plan to test.


### Human fetal kidney atlas Stewart et al.

We first wanted to try the human fetal kidney atlas to transfer label into the Wilms tumor samples using azimuth. 
You can find more about the human kidney atlas here: https://www.kidneycellatlas.org/ [3]

Using this reference, we test two workflows for label transfer:

- `Azimuth v5`,
- `Seurat v4` as described here  https://satijalab.org/seurat/articles/integration_mapping.html#cell-type-classification-using-an-integrated-reference


### Azimuth Human fetal atlas Cao et al.

Azimuth also provide a human fetal atlas as a reference [4]. 

The data can be found on Zenodo: 
https://zenodo.org/records/4738021#.YJIW4C2ZNQI

The reference contain cells from 15 organs including kidney from fetal samples. 
Here we will use `Azimuth` to transfer labels from the reference.

##########################################################################################################
In this notebook, we will test the human fetal Azimuth reference from Cao et al. using Azimuth . 
##########################################################################################################


### Packages

Load required packages in the following chunk, if needed.
Do not install packages here; only load them with the `library()` function.

```{r packages, message=FALSE, warning=FALSE}
library(SingleCellExperiment)

library("Seurat")
library(sctransform)
library(Azimuth)
library(SeuratData)

library(assertthat)
library(viridis)
library(SCpubr)
library(tidyverse)
library(patchwork)

set.seed(params$seed)
```


### Base directories

```{r base paths, eval=TRUE, include=TRUE}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
repository_base <- rprojroot::find_root(rprojroot::is_git_root)

# The current data directory, found within the repository base directory
data_dir <- file.path(repository_base, "data", params$current, params$scpca_project_id)

# The path to this module
module_base <- file.path(repository_base, "analyses", "cell-type-wilms-tumor-06")
```


### Input files

#### Reference

We install and load the reference using `Azimuth`.
```{r path_to_reference}
#Check the names of the Azimuth available data and reference
AvailableData()

# Install the fetal reference 
InstallData("fetusref")

ref <- SeuratData::LoadData("fetusref", type = "azimuth")
```

#### Query

In this notebook, we test the label transfer from the azimuth fetal atlas (reference) to the Wilms tumor sample defined in `params$sample_id` from the Wilms tumor dataset `param$scpca_project_id` 

```{r path_to_query}
filelist <- list.files(data_dir, full.names = TRUE)

# select the 40 Wilms tumor single nucleus folders only
filedir <- filelist[grepl(params$sample_id, filelist)]
```

### Output file

Reports will be saved in the `notebook/00-reference` directory. 


### Load and pre-process the query data

```{r load, message=FALSE, warning=FALSE}
file <- list.files(filedir)
file <- file[grepl("_processed.rds", file)]

# open the processed rds object
sce <- readRDS(paste0(filedir, "/", file))
```

```{r seurat_wf, fig.height=4, fig.width=8, warning=FALSE, out.width='100%'}
# convert to seurat
srat <- CreateSeuratObject(counts = counts(sce),
                                    assay = "RNA",
                                    project = params$sample_id
                           )

# convert colData and rowData to data.frame for use in the Seurat object
cell_metadata <- as.data.frame(colData(sce))
row_metadata <- as.data.frame(rowData(sce))

# add cell metadata (colData) from SingleCellExperiment to Seurat
srat@meta.data <- cell_metadata

# add row metadata (rowData) from SingleCellExperiment to Seurat
srat[["RNA"]]@meta.data <- row_metadata

# add metadata from SingleCellExperiment to Seurat
srat@misc <- metadata(sce)


# Normalization
options(future.globals.maxSize= 8912896000000)
srat <- SCTransform(srat, verbose = F, conserve.memory = TRUE)

# dimensionality reduction
srat <- RunPCA(srat, verbose = F)
srat <- RunUMAP(srat, dims = 1:50, verbose = F)

# clustering
srat    <- FindNeighbors(srat, dims = 1:50, verbose = F)
srat    <- FindClusters(srat, verbose = T)
  
```

### Label transfer from fetal kidney reference using Azimuth

```{r fig.height=6, fig.width=6, message=FALSE, warnings=FALSE}
DefaultAssay(srat) <- "RNA"
s <- RunAzimuth(srat, reference ="fetusref" )
```

```{r fig.height=15, fig.width=8, warnings=FALSE}

d1 <- DimPlot(s, reduction = "umap", dims = c(1,2), group.by = "predicted.organ", label = TRUE, repel = TRUE) + NoLegend()
d2 <- DimPlot(s, reduction = "umap", dims = c(1,2), group.by = "predicted.annotation.l1", label = TRUE, repel = TRUE) + NoLegend()
d3 <- DimPlot(s, reduction = "umap", dims = c(1,2), group.by = "predicted.annotation.l2", label = TRUE, repel = TRUE) + NoLegend()

f1 <- SCpubr::do_BarPlot(sample = s,
                         group.by = "predicted.organ",
                         split.by = "seurat_clusters",
                         position = "fill",
                         font.size = 10,
                         legend.ncol = 4) +
                         ggtitle("% cells")+
                         xlab(file)

f2 <- SCpubr::do_BarPlot(sample = s,
                         group.by = "predicted.annotation.l1",
                         split.by = "seurat_clusters",
                         position = "fill",
                         font.size = 10,
                         legend.ncol = 2) +
                         ggtitle("% cells")+
                         xlab(file)

f3 <- SCpubr::do_BarPlot(sample = s,
                         group.by = "predicted.annotation.l2",
                         split.by = "seurat_clusters",
                         position = "fill",
                         font.size = 10,
                         legend.ncol = 2) +
                         ggtitle("% cells")+
                         xlab(file)

((d1/f1) | (d2/f2) ) 
```

## Session info

```{r }
sessionInfo()
```


## References 

- [1] https://www.ncbi.nlm.nih.gov/books/NBK373356/ 

- [2] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9915828/ 

- [3] https://www.science.org/doi/10.1126/science.aat5031 

- [4] https://www.science.org/doi/10.1126/science.aba7721