---
title: "Annotation exploration for `r params$scpca_project_id`"
author: "Maud PLASCHKA"
date: '2024-08-13'
params:
  scpca_project_id: "SCPCP000006"
  sample_id: "SCPCS000176"
  seed: 12345
output: 
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
    highlight: pygments
    df_print: paged
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE,
                      message=FALSE,
                      warnings=FALSE
                      )

```


## Introduction


The aim is to explore the annotations and label transfers for all of the samples in `r params$scpca_project_id`.


In order to explore the label transfer results, we look into some marker genes, table and percentages of cells in each annotation groups (from label transfers).


### Packages


```{r packages, message=FALSE, warning=FALSE}
library(Seurat)
library(tidyverse)
library(patchwork)

set.seed(params$seed)
```


### Base directories

```{r base paths, eval=TRUE}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
repository_base <- rprojroot::find_root(rprojroot::is_git_root)

# The current data directory, found within the repository base directory
data_dir <- file.path(repository_base, "data", "current", params$scpca_project_id)

# The path to this module
module_base <- file.path(repository_base, "analyses", "cell-type-wilms-tumor-06")

result_dir <- file.path(module_base, "results")
```


### Input files

In this notebook, we are working with all of the samples in `r params$scpca_project_id`.

The sample metadata can be found in `sample_metadata_file` in the `data` folder.

We extracted from the pre-processed and labeled `Seurat` object (that is the output of `02b_label-transfer_fetal_kidney_reference_Stewart.Rmd` saved in the `results` directory)
the following information per cell:

- the predicted compartment in `fetal_kidney_predicted.compartment` 

- the predicted organ in `fetal_full_predicted.organ`

- the sample identifier in `sample_id`

- the `counts`of the endothelial marker VWF = "ENSG00000110799"

- the `counts`of the immune marker PTPRC = "ENSG00000081237"


```{r path_to_query}
sample_metadata_file <- file.path(repository_base, "data", "current", params$scpca_project_id, "single_cell_metadata.tsv")

metadata <- read.table(sample_metadata_file, sep = "\t", header = TRUE)

# Create a data frames of all annotations
cell_type_df <- metadata$scpca_sample_id |>
  purrr::map(
    # For each sample_id, do the following:
    \(sample_id) {

      # Read in the Seurat object
      srat <- readRDS(
        file.path(result_dir, sample_id, paste0("02b-fetal_kidney_label-transfer_", sample_id, ".Rds"))
      )

      # Create and return a data frame from the Seurat object with relevant annotations
      # this data frame will have four columns: barcode, sample_id, compartment, organ
      data.frame(
        compartment = srat$fetal_kidney_predicted.compartment,
        organ = srat$fetal_full_predicted.organ, 
        PTPRC = FetchData(object = srat, vars = "ENSG00000081237", layer = "counts"),
        VWF = FetchData(object = srat, vars = "ENSG00000110799", layer = "counts")
        ) |>
        tibble::rownames_to_column("barcode") |>
        dplyr::mutate(sample_id = sample_id)
    }
  ) |>
  # now combine all dataframes to make one big one
  dplyr::bind_rows()

```

### Output file

The report will be saved in the `notebook` directory. 


## Functions


#### do_Table_Heatmap

`do_Table_Heatmap` shows heatmap of counts of cells for combinations of two metadata variables

- `first_group` is the name of the first metadata to group the cells
- `last_group` is the name of the second metadata to group the cells

```{r fig.width=10, fig.height=4, out.width='100%'}
do_Table_Heatmap <- function(first_group, last_group ){
  
  df <- cell_type_df %>%
  group_by( !!sym(first_group), !!sym(last_group))%>% 
  summarise(Nb = n())  %>%
  mutate(C = sum(Nb)) %>%
  mutate(percent = Nb/C*100)

  
p1 <- ggplot(df, aes(x= !!sym(first_group), y = !!sym(last_group), fill = Nb)) +
   geom_tile() +
   scale_fill_viridis_c()  +
   theme_bw() +
   theme(text = element_text(size = 20)) +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
   guides(fill=guide_legend(title=" Number of \n cells"))

p2 <- ggplot(df, aes(x= !!sym(first_group), y = !!sym(last_group), fill = percent)) +
   geom_tile() +
   scale_fill_viridis_c()  +
   theme_bw() +
   theme(text = element_text(size = 20)) +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
   guides(fill=guide_legend(title=" Percentage of \n cells"))

p <- p1 + p2 + plot_layout(ncol = 2)
return(p)
}
```

#### do_Feature_mean

`do_Feature_mean` shows heatmap of mean expression of a feature grouped by a metadata. 

- `group.by` is the name of the metadata to group the cells
- `feature` is the name of the gene to average the expression

```{r fig.width=10, fig.height=4, out.width='100%'}
do_Feature_mean <- function(group.by, feature ){
  
  df <- cell_type_df %>%
  group_by(sample_id, !!sym(group.by))%>% 
  summarise(m = mean(!!sym(feature)))  

  
p <- ggplot(df, aes(x= sample_id, y = !!sym(group.by), fill = m)) +
   geom_tile() +
   scale_fill_viridis_c()  +
   theme_bw() +
   theme(text = element_text(size = 20)) +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
   guides(fill=guide_legend(title=paste0(feature)))

return(p)
}
```

## Analysis

### Total number of cells per samples

```{r fig.width=5, fig.height=10, out.width='100%', results='asis'}
tmp <- table(cell_type_df$sample_id)
knitr::kable(tmp)
```
### Predicted organ

The predicted organ comes from label transfer from the human fetal atlas. 
This is the reference developed by [Cao et al.](https://www.science.org/doi/10.1126/science.aba7721) provided by `Azimuth` for label transfer.
The reference contain cells from 15 organs including kidney from fetal samples.
The label transfer have been performed in the notebook `02a_fetal_full_reference_Cao_{sample_id}.Rmd`

The fetal full reference (Cao et al.) provides three levels of annotations:

- `fetal_full_predicted.organ` is one of the 15 organs used for building the reference. 
We were nicely surprised that, for many of the samples, most of the cells from the Wilms tumor cohort mapped to fetal kidney cells. 

- `fetal_full_predicted.annotation.l1` holds predicted cell type annotation

- `fetal_full_predicted.annotation.l2` holds the combination of the predicted organ and predicted cell type annotation

    

```{r fig.width=25, fig.height=6,  results='asis'}
tmp <- table(cell_type_df$sample_id, cell_type_df$organ)

knitr::kable(tmp)
```

```{r fig.width=25, fig.height=6}
do_Table_Heatmap(first_group = "sample_id", last_group = "organ")
```

### Predicted compartment

The predicted compartment is the result of the label transfer fron the human fetal kidney atlas: 
[Stewart et al.](https://www.science.org/doi/10.1126/science.aat5031) created a [human fetal kidney atlas](https://www.kidneycellatlas.org/). 
This reference contains only fetal kidney cells and has been precisely annotated by kidney experts. 
The label transfer have been performed in the notebook `02b_fetal_kidney_reference_Stewart_{sample_id}.Rmd`

The fetal kidney reference (Stewart et al.) provides two levels of annotations:

- `fetal_kidney_predicted.compartment` is one of the 4 main compartments composing a fetal kidney.
We expect immune and endothelial cells to be healthy (non-canerous) cells identified easily with high confidency. 
We expect stroma and fetal nephron compartment to contain both normal and malignant cells.

    
    - `immune` cells
    
    - `stroma` cells
    
    - `fetal_nephron` cells
    
    - `endothelial` cells
    


- `fetal_kidney_predicted.cell_type` holds predicted cell type annotations that details further the four compartments, as for example:

    - `immune` subtypes: myeloid cells, lymphocytes, ...
    
    - `stroma` subtypes: mesenchymal stem cells, fibroblasts, ...
    
    - `fetal_nephron` subtypes: podocytes, uteric bud, mesenchymal cells (that appear to be cap mesenchyme cells) ...
    
    - `endothelial` cells


We think that the first level of annotation `fetal_kidney_predicted.compartment` can be useful in identifying non-cancer cells, at least the endothelial and immune cells. 


```{r fig.width=25, fig.height=3, results='asis'}
tmp <- table(cell_type_df$sample_id, cell_type_df$compartment)

knitr::kable(tmp)
```

```{r fig.width=25, fig.height=3}

do_Table_Heatmap(first_group = "sample_id", last_group = "compartment")
```



### Evaluate annotations with marker genes

Here we evaluate with marker genes the identification of endothelial, immune cells sub-populations.


##### Endothelial cells

We look at the endothelial marker "ENSG00000110799" = "VWF"

```{r fig.height=3, fig.width=15, message=FALSE, warning=FALSE, out.width='100%'}
do_Feature_mean(  feature = "ENSG00000110799",
                  group.by = "compartment")
```

##### Immune cells

We look at the immune marker "ENSG00000081237" = "PTPRC" alias "CD45"


```{r fig.height=3, fig.width=15, message=FALSE, warning=FALSE, out.width='100%'}
do_Feature_mean(  feature = "ENSG00000081237",
                  group.by = "compartment")
```


## Session Info

```{r session info}
# record the versions of the packages used in this analysis and other environment information
sessionInfo()
```


