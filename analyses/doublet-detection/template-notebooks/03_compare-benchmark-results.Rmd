---
title: "Comparison among doublet predictions on benchmarking datasets"
author: Stephanie J. Spielman
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: true
    toc_depth: 4
    code_folding: hide
---

## Setup

### Packages


```{r packages}
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(ggplot2)
  library(patchwork)
  library(caret)
  library(UpSetR)
})

theme_set(theme_bw())
```

### Paths


```{r base paths}
module_base <- rprojroot::find_root(rprojroot::is_renv_project)
data_dir <- file.path(module_base, "scratch", "benchmark-datasets")
result_dir <- file.path(module_base, "results", "benchmark-results")
```

### Functions

Import shared functions:
```{r}

plot_pca <- function(df, 
                     color_column, 
                     pred_column = NULL,
                     color_type = "d",
                     color_lab) {
  # Plot PCs colored by either discrete or continuous color variable, showing doublets on top
  # df is expected to contain columns PC1, PC2, `color_column`, and if color_type == "c" also `pred_column`. These should _not_ be provided as strings
  # By default, this function assumes a discrete color variable (`color_type = "d"`) with two levels. Use `color_type = "c"` for continuous. 
  
  p <- ggplot(df) + 
    aes(x = PC1, 
        y = PC2, 
        color = {{color_column}}) +
  geom_point(alpha = 0.5) + 
  labs(color = color_lab) + 
  theme(
    legend.title.position = "top",
    legend.position = "bottom"
  )
  
  # Set the palette, and ensure doublets are on top for visibility
  if (color_type == "d") {
    p <- p + 
      scale_color_manual(values = c("black", "lightblue")) + 
    geom_point(
      data = dplyr::filter(df, {{color_column}} == "doublet"), 
      color = "black"
    )
  } else if (color_type == "c") {
    p <- p + 
      scale_color_viridis_c(direction = -1) + 
    geom_point(
      data = dplyr::filter(df, {{pred_column}} == "doublet"), 
      aes(color = {{color_column}})
    )
  }
  
  return(p)
}
```


### Read and prepare input data

First, we'll read in and combine doublet results into a list of data frames for each dataset.
We'll also two columns for each dataset:

- `consensus_call`, which will be "doublet" if _all_ methods predict "doublet," and "singlet" otherwise
- `call_type`, which will classify the consensus call as one of "tp", "tn", "fp", or "fn" (true/false positive/negative) 

```{r paths}
# find all dataset names to process:
dataset_names <- list.files(result_dir, pattern = "*_scrublet.tsv") |>
  stringr::str_remove("_scrublet.tsv")
```

```{r read_data}
# Read in and data for analysis
doublet_df_list <- dataset_names |>
  purrr::map(
    \(dataset) {
      
      scdbl_tsv <- file.path(result_dir, glue::glue("{dataset}_scdblfinder.tsv"))
      scrub_tsv <- file.path(result_dir, glue::glue("{dataset}_scrublet.tsv"))
      sce_file <- file.path(data_dir, dataset, glue::glue("{dataset}_sce.rds"))
      
      scdbl_df <- scdbl_tsv |>
        readr::read_tsv(show_col_types = FALSE) |>
        dplyr::select(
          barcodes,
          cxds_score, 
          scdbl_score = score, 
          scdbl_prediction  = class
        ) |>
        # add cxds calls at 0.75 threshold
        dplyr::mutate(
          cxds_prediction = dplyr::if_else(
            cxds_score >= 0.75,
            "doublet",
            "singlet"
          )
        ) 
      
      scrub_df <- readr::read_tsv(scrub_tsv, show_col_types = FALSE) 

      # grab ground truth and PCA coordinates
      sce <- readr::read_rds(sce_file)
      sce_df <- scuttle::makePerCellDF(sce, use.dimred = "PCA") |>
        tibble::rownames_to_column(var = "barcodes") |>
        dplyr::select(barcodes,
                      ground_truth = ground_truth_doublets, 
                      PC1 = PCA.1, 
                      PC2 = PCA.2)
      rm(sce)
      
      dataset_df <- scdbl_df |>
        dplyr::left_join(
          scrub_df, 
          by = "barcodes"
        ) |>
        dplyr::left_join(
          sce_df, 
          by = "barcodes"
        ) 
      
      # Add a consensus call column
      dataset_df <- dataset_df |>
        dplyr::rowwise() |>
        dplyr::mutate(consensus_call = dplyr::if_else(
          all(
            c(scdbl_prediction, scrublet_prediction, cxds_prediction) == "doublet"
          ),
          "doublet", 
          "singlet"
        )) |>
        dplyr::mutate(
          call_type = dplyr::case_when(
            consensus_call == "doublet" && ground_truth == "doublet" ~ "tp",
            consensus_call == "singlet" && ground_truth == "singlet" ~ "tn",
            consensus_call == "doublet" && ground_truth == "singlet" ~ "fp",
            consensus_call == "singlet" && ground_truth == "doublet" ~ "fn"
          ), 
          # set associated plotting colors
          call_type_color = dplyr::case_when(
            call_type == "tp" ~ "blue4",
            call_type == "tn" ~ "blue",
            call_type == "fp" ~ "brown1",
            call_type == "fn" ~ "darkorange1"
          )
          )
      
      return(dataset_df)
    }
  )
names(doublet_df_list) <- dataset_names
```




## Viz: PCA



```{r, fig.width = 10}
doublet_df_list |>
  purrr::iwalk(
    \(df, dataset) {
      
      # First, ground truth
      p1 <- plot_pca(
        df, 
        color_column = ground_truth, 
        color_lab = "Ground truth"
      )
      
      # Second, consensus call
      p2 <- plot_pca(
        df, 
        color_column = consensus_call, 
        color_lab = "Consensus call"
      )
      
      # Third, call type
      p3 <- ggplot(df) + 
        aes(x = PC1, y = PC2, color = call_type_color) + 
        geom_point(alpha = 0.6, size = 0.25) + 
        scale_color_identity()
      

      # combine and plot
      plot( p1 + p2 + p3 + plot_annotation(glue::glue("PCA for {dataset}")) )
    }
  )
```



## Session Info

```{r session info}
# record the versions of the packages used in this analysis and other environment information
sessionInfo()
```
