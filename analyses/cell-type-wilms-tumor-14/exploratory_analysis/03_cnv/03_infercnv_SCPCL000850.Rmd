---
title: "Exploratory CNV analysis using inferCNV"
author: "Jingxuan Chen"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

Here we test `inferCNV` to analyze the CNV profile for Wilms tumor sample (SCPCL000850), aiming to identify potential tumor cells from normal cells.

Before running this notebook, one should first generate `inferCNV` outputs as in `03_runInferCNV.R`.

## Setup

### Packages

```{r packages}
suppressPackageStartupMessages({
  library(dplyr)
  library(Seurat)
  library(infercnv)
  library(ggplot2)
})
```

### Paths

#### Base directories

```{r base paths}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
path_repo <- rprojroot::find_root(rprojroot::is_git_root)

# The path to this module
path_anal <- file.path(path_repo,"analyses","cell-type-wilms-tumor-14") 
```

#### Input and output files

Only run for one sample

```{r paths}
library_id <- "SCPCL000850"
scratch_out_dir <- file.path(path_anal, "scratch", "03_cnv","infercnv")
dir.create(scratch_out_dir, showWarnings = FALSE, recursive = TRUE)
library_out_dir <- file.path(scratch_out_dir, library_id)
dir.create(library_out_dir, showWarnings = FALSE, recursive = TRUE)

## Input files
# load pre-processed sample objs & anchor transfer results
obj <- SeuratObject::LoadSeuratRds( file.path(path_anal,"scratch","00_preprocessing_rds",paste0(library_id,".rdsSeurat")) )
level <- "compartment"
predictions <- read.csv( file.path(path_anal, "results", "01_anchor_transfer_seurat", paste0(library_id, "_", level,".csv")) ) 
obj <- AddMetaData(object = obj, metadata = predictions)
infercnv_result <- readr::read_rds( file = file.path(library_out_dir, "run.final.infercnv_obj") )
# add infercnv output to seurat object
obj_cnv <- infercnv::add_to_seurat(
  seurat_obj = obj,
  infercnv_output_path = library_out_dir
)
```

```{r images}
heatmap_wref <- file.path(library_out_dir, "infercnv.png")
normal_level <- "immune"
```

## Analysis content

Here, "immune" cells annotated with anchor transfer were used as reference normal cells. Here is the heatmap generated by the software:

```{r, echo=FALSE, out.width = '100%'}
knitr::include_graphics(heatmap_wref)
```

We could observe some different CNV profiles between "fetal_nephron" and "stroma", especially chr1 and chr11. However, it's hard to observe any different CNV profiles within the "fetal_nephron" subgroups. 

`inferCNV` outputs results for each Chromosome. Thus, I applied several ways to summarize the overall CNV profile.

#### CNV score - proportion of genes with CNV

Based on [this](https://www.biostars.org/p/9573777/) Biostars discussion, I calculated a `cnv_score`, which basically indicates the proportion of CNVs across all genes.

```{r}
## summary strategy 1 https://www.biostars.org/p/9573777/
scores <- apply(infercnv_result@expr.data, 2 ,function(x){ sum(x < 0.95 | x > 1.05)/length(x) }) %>% 
  as.data.frame() %>%
  mutate(pred = obj$predicted.id) %>%
  mutate(cnv_score = ifelse(
    pred == normal_level,
    NA,
    .
  ))
```

Ideally, we should observe bimodal distribution for this score, indicating the CNV difference between normal and tumor cells. However, here we could get a distribution close to normal.
```{r}
hist(scores$cnv_score, breaks = 100)
```

By plotting the CNV score onto UMAP, no clear pattern is shown.
```{r}
obj <- AddMetaData(object = obj, metadata = scores)
FeaturePlot(obj, features = "cnv_score", alpha = 0.3) +
  scale_color_viridis_c()
```

#### Summary based upon number of chromosomes that have CNV
This strategy to summary CNV results is based on [`cell-type-ewings`](https://github.com/AlexsLemonade/OpenScPCA-analysis/tree/main/analyses/cell-type-ewings/template_notebooks/cnv-workflow) module.

```{r}
## summary strategy 2 ewings analysis, based on number of chr that have cnv
cnv_df <- obj_cnv@meta.data %>%
  select(matches("predicted.id") | starts_with("has_cnv_chr") & !matches("has_cnv_chrMT")) %>%
  mutate(count_cnv_chr = ifelse(predicted.id == normal_level,
                            NA,
                            rowSums(across(starts_with("has_cnv_chr")))
                            ) )
```

```{r}
hist(cnv_df$count_cnv_chr)
```

```{r}
obj <- AddMetaData(object = obj, metadata = cnv_df)
FeaturePlot(obj, features = "count_cnv_chr", alpha = 0.3) +
  scale_color_viridis_c()
```

#### Summary based upon weighted means of CNV proportion
This strategy to summary CNV results is based on [`cell-type-ewings`](https://github.com/AlexsLemonade/OpenScPCA-analysis/tree/main/analyses/cell-type-ewings/template_notebooks/cnv-workflow) module.

```{r}
## summary strategy 3 ewings analysis, based on number of chr that have cn
chr_weights <- infercnv_result@gene_order |> 
  as.data.frame() |> 
  dplyr::count(chr) |> 
  # only keep chr 1-22, drops MT and GL chr
  dplyr::filter(chr %in% glue::glue("chr{seq(1,22)}")) |> 
  dplyr::pull(n)

cnv_df <- obj_cnv@meta.data %>%
  select(matches("predicted.id") | starts_with("proportion_scaled_cnv_chr") & !ends_with("chrMT")) %>%
  rowwise() %>%
  mutate(weight_mean = ifelse(
    predicted.id == normal_level,
    NA,
    weighted.mean(across(starts_with("proportion_scaled_cnv_chr")), chr_weights/sum(chr_weights))
  ) )
```

```{r}
hist(cnv_df$weight_mean)
```

```{r}
obj <- AddMetaData(object = obj, metadata = cnv_df)
FeaturePlot(obj, features = "weight_mean", alpha = 0.3) +
  scale_color_viridis_c()
```

In conclusion, the heatmap generated by `inferCNV` indicates different CNV profiles between `fetal_nephron` and `stroma`, especially in Chr1. However, none of the three summary strategies seem working. 

## Session Info

```{r session info}
# record the versions of the packages used in this analysis and other environment information
sessionInfo()
```
