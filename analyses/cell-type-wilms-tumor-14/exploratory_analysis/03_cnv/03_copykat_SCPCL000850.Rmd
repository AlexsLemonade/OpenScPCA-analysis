---
title: "Exploratory analysis using Copykat"
author: "Jingxuan Chen"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

Here we test `CopyKat` to analyze the CNV profile for Wilms tumor sample (SCPCL000850), aiming to identify potential tumor cells from normal cells.

Before running this notebook, one should first generate `CopyKat` outputs as in `03_runCopyKat.R`.

## Setup

### Packages

```{r packages}
suppressPackageStartupMessages({
  library(dplyr)
  library(Seurat)
  library(copykat)
  library(ggplot2)
})
```

### Paths


#### Base directories

```{r base paths}
# The base path for the OpenScPCA repository, found by its (hidden) .git directory
path_repo <- rprojroot::find_root(rprojroot::is_git_root)

# The path to this module
path_anal <- file.path(path_repo,"analyses","cell-type-wilms-tumor-14") 
```

#### Input and output files

Only run for one sample

```{r paths}
library_id <- "SCPCL000850"
scratch_out_dir <- file.path(path_anal, "scratch", "03_cnv","copykat")
dir.create(scratch_out_dir, showWarnings = FALSE, recursive = TRUE)
library_out_dir <- file.path(scratch_out_dir, library_id)
dir.create(library_out_dir, showWarnings = FALSE, recursive = TRUE)

## Input files
# load pre-processed sample objs & anchor transfer results
obj <- SeuratObject::LoadSeuratRds( file.path(path_anal,"scratch","00_preprocessing_rds",paste0(library_id,".rdsSeurat")) )
level <- "compartment"
predictions <- read.csv( file.path(path_anal, "results", "01_anchor_transfer_seurat", paste0(library_id, "_", level,".csv")) ) 
obj <- AddMetaData(object = obj, metadata = predictions)
copykat_result <- readr::read_rds( file = file.path(library_out_dir, paste0(library_id, "_copykat_resultobj.rds")) )
copykat_result_noref <- readr::read_rds( file = file.path(library_out_dir, paste0(library_id, "_noref_copykat_resultobj.rds")) )

```

```{r images}
heatmap_wref <- file.path(library_out_dir, paste0(library_id, "_copykat_heatmap.jpeg"))
heatmap_noref <- file.path(library_out_dir, paste0(library_id, "_noref_copykat_heatmap.jpeg"))
```

## Analysis content

#### Run CopyKat with normal cells

Here, "immune" cells annotated with anchor transfer were used as reference normal cells. Here is the heatmap generated by the software:

```{r, echo=FALSE, out.width = '100%'}
knitr::include_graphics(heatmap_wref)
```

Frequency of predicted `aneuploid`, `diploid`, and `not.defined` categories.

```{r}
copykat_df <- copykat_result$prediction %>%
  select(copykat.pred) %>% 
  rename(c("ref.copykat" = "copykat.pred"))
table(copykat_df)
```

Plot CopyKat identifications onto UMAP.

```{r}
obj <- AddMetaData(object = obj, metadata = copykat_df)
DimPlot(obj, group.by = "ref.copykat", alpha = 0.3)
```

#### Run CopyKat without normal cells

Here, no normal cells were provided to CopyKat.

```{r, echo=FALSE, out.width = '100%'}
knitr::include_graphics(heatmap_noref)
```

Frequency of predicted `aneuploid`, `diploid`, and `not.defined` categories.

```{r}
copykat_noref_df <- copykat_result_noref$prediction %>%
  select(copykat.pred) %>% 
  rename(c("noref.copykat" = "copykat.pred"))
table(copykat_noref_df)
```

Plot CopyKat identifications onto UMAP.

```{r}
obj <- AddMetaData(object = obj, metadata = copykat_noref_df)
DimPlot(obj, group.by = "noref.copykat", alpha = 0.3)
```

In this Wilms tumor sample (SCPCL000850), it's likely that CopyKat is not working well: (i) The result with or without specifying normal cells are not consistent; (ii) From the heatmap, no much differences in CNV profile could be observed.

## Session Info

```{r session info}
# record the versions of the packages used in this analysis and other environment information
sessionInfo()
```
